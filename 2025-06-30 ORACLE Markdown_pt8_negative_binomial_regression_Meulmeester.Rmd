---
title: "2025-06-30 ORACLE Markdown_pt8_negative_binomial_regression"
author: "FL Meulmeester"
date: "2025-06-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<style>
body {
text-align: justify}
</style>

<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

<style type="text/css">
.main-container {
  max-width: 1600px;
  margin-left: auto;
  margin-right: auto;
}
</style>


# Loading the libraries
 
```{r Packages, eval = FALSE, results = 'hide'}

# Set CRAN mirror
r <- getOption("repos")
r["CRAN"] <- "http://cran.us.r-project.org"
options(repos = r)

# Vector of required packages
Packages <- c(
  "readstata13", "readxl", "dplyr", "tidyverse", "data.table", "ggplot2", "car",
  "epiDisplay", "lubridate", "table1", "mice", "VIM", "caret", "lsr", "tidymodels",
  "sjPlot", "stargazer", "Gmisc", "purrr", "corrplot", "ggcorrplot", "Hmisc",
  "naniar", "lme4", "MASS", "broom", "nnet", "pROC", "rms", "gridExtra",
  "survival", "ggsurvfit", "survminer", "fmsb", "DescTools"
)

# Install any missing packages
installed <- Packages %in% rownames(installed.packages())
if (any(!installed)) {
  install.packages(Packages[!installed])
}

# Load all packages
# Use invisible() to keep your console output clean
invisible(lapply(Packages, library, character.only = TRUE))
```


# Data import

```{r, eval = FALSE}
# This R code uses the multiply imputed data; two datasets: one with imputed values of systematically missings put back to NA (_sysREMOVED) and one with no missing/totally completed (_COMPLETE) -- see pt6 of the ORACLE Markdown for the imputation process

imp_data_ORACLE_final_COMPLETE <- read.csv('xxxx-xx-xx imp_data_ORACLE_final_COMPLETE.csv')
imp_data_ORACLE_final_sysREMOVED <- read.csv('xxxx-xx-xx imp_data_ORACLE_final_COMPLETE.csv')

# For the adjusted negative binomial analyses, the mids object of the imputation is required
imp_data_ORACLE_final <- readRDS("Network/xxxx-xx-xx imp_data_ORACLE_final.RData")

```


# Scaling 25-75th percentile biomarkers (method prof. Frank Harrell)

```{r, eval = FALSE}
# Create a variable with the original values for FeNO and BEC (not log-transformed)

imp_data_ORACLE_final_COMPLETE$FeNO <- 10^imp_data_ORACLE_final_COMPLETE$FeNO_baseline_ppb
imp_data_ORACLE_final_sysREMOVED$FeNO <- 10^imp_data_ORACLE_final_sysREMOVED$FeNO_baseline_ppb

imp_data_ORACLE_final_COMPLETE$BEC <- 10^imp_data_ORACLE_final_COMPLETE$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced
imp_data_ORACLE_final_sysREMOVED$BEC <- 10^imp_data_ORACLE_final_sysREMOVED$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced
```


```{r, eval = FALSE}
# Calculate and display the quantiles (25th and 75th percentiles) for the FeNO variable
quantile(imp_data_ORACLE_final_COMPLETE$FeNO)     # Display quantiles for FeNO in the first dataset
quantile(imp_data_ORACLE_final_sysREMOVED$FeNO)  # Display quantiles for FeNO in the second dataset
```


```{r, eval = FALSE}
# Scaling FeNO based on the 25th and 75th percentiles (method by Prof. Frank Harrell)
imp_data_ORACLE_final_COMPLETE <- imp_data_ORACLE_final_COMPLETE %>%
  mutate(FeNO_p = FeNO / 28)  # Scale FeNO by dividing by 28 (between the 25th and 75th percentiles)

imp_data_ORACLE_final_sysREMOVED <- imp_data_ORACLE_final_sysREMOVED %>%
  mutate(FeNO_p = FeNO / 28)  # Same scaling for the second dataset
```


```{r, eval = FALSE}
# Calculate and display the quantiles (25th and 75th percentiles) for the BEC variable
quantile(imp_data_ORACLE_final_COMPLETE$BEC)  # Display quantiles for BEC in the first dataset
quantile(imp_data_ORACLE_final_sysREMOVED$BEC)  # Display quantiles for BEC in the second dataset
```

```{r, eval = FALSE}
# Scaling BEC based on the 25th and 75th percentiles (method by Prof. Frank Harrell)
imp_data_ORACLE_final_COMPLETE <- imp_data_ORACLE_final_COMPLETE %>%
  mutate(BEC_p = BEC / 0.28)  # Scale BEC by dividing by 0.28 (between the 25th and 75th percentiles)

imp_data_ORACLE_final_sysREMOVED <- imp_data_ORACLE_final_sysREMOVED %>%
  mutate(BEC_p = BEC / 0.28)  # Same scaling for the second dataset
```


# Negative binomial model: multivariable adjusted for core clinical set (25-75th percentile scaling)

```{r, eval = FALSE}
# Use the 25-75th percentile scaled variable for FeNO and BEC in a mutlivariable adjusted negative binomial model

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                FeNO_p + # FeNO scaled with 25-75th percentile
                Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                FEV1_preBD_PCT_Baseline + 
                Treatment_step + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMPLETE, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```


```{r, eval = FALSE}
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = 
       glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                BEC_p + # BEC scaled with 25-75th percentile
                FeNO_baseline_ppb + 
                ACQ_baseline_score_mean + 
                Any_severe_attack_previous_12m_0no_1yes + 
                FEV1_preBD_PCT_Baseline + 
                Treatment_step + 
                offset(Follow_up_duration_days) + 
                as.factor(Enrolled_Trial_name), 
              data = subset(imp_data_ORACLE_final_COMPLETE, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```


# Negative binomial model: univariable

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Age as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Age + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Sex as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

# First, select males as the reference
imp_data_ORACLE_final_sysREMOVED$Gender_0Female_1Male <- 
  relevel(imp_data_ORACLE_final_sysREMOVED$Gender_0Female_1Male, ref = "1")

# Then, fit the model
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Gender_0Female_1Male + 
                              offset(Follow_up_duration_days) + 
                              as.factor(Enrolled_Trial_name), 
                        data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}



res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BMI as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ BMI + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and GINA treatment step as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

# First, select treatment step 3 as the reference
imp_data_ORACLE_final_sysREMOVED$Treatment_step <- 
  relevel(imp_data_ORACLE_final_sysREMOVED$Treatment_step, ref = "3")

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Treatment_step + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Attack history as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Any_severe_attack_previous_12m_0no_1yes +  offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of hospitalisations in the past 12 months as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Number_hospitalisations_for_asthma_previous_12_months_con +  offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Smoking behaviour as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Smoking_0never_1ex_2current + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Pack years as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Pack_years + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergic Rhinitis as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ AllergicRhinitis__0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Eczema as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Eczema_0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergy sensitisation as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Chronic Rhinosinusitis as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ CRSsNP + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Nasal polyposis as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ CRSwNP + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Adherence in Trial as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Adherence_InTrial_quantity + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% pre-bronchodilator as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_preBD_PCT_Baseline + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% post-bronchodilator as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_postBD_PCT_Baseline + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% reversibility as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_PCT_reversibility_postBD + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1/FVC ratio as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FEV1_FVC_ratio + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and ACQ-5 symptom score as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ ACQ_baseline_score_mean + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BEC per 10-fold as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BEC per 2-fold as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

# First, transform the original values of BEC to log with base 2
imp_data_ORACLE_final_sysREMOVED$BEC <- 
  10^(imp_data_ORACLE_final_sysREMOVED$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced)

imp_data_ORACLE_final_sysREMOVED$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced_log2 <-
  log(imp_data_ORACLE_final_sysREMOVED$BEC, base=2)

# Then, fit the model
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced_log2 + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FeNO per 10-fold as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FeNO_baseline_ppb + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FeNO per 2-fold as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

# First, transform the original values for FeNO to log with base 2
imp_data_ORACLE_final_sysREMOVED$FeNO <- 
  10^(imp_data_ORACLE_final_sysREMOVED$FeNO_baseline_ppb)

imp_data_ORACLE_final_sysREMOVED$FeNO_baseline_ppb_log2 <- 
  log(imp_data_ORACLE_final_sysREMOVED$FeNO, base=2)

# Then, fit the model
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ FeNO_baseline_ppb_log2 + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Total IgE as independent variable, adjusted for offset follow-up duration and trial as factor variable. Rubin's rules were applied.

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ Total_IgE + offset(Follow_up_duration_days) + as.factor(Enrolled_Trial_name), data = subset(imp_data_ORACLE_final_sysREMOVED, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


# Negative binomial model: multivariable adjusted for core clinical set + biomarkers

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Age as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Age + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit)) # pool the estimates following the Rubin's rules
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3])))) # include exponent of the estimate as the rate ratio and the 95% CI of the rate ratio

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Sex as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Gender_0Female_1Male + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes +
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BMI as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         BMI + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and GINA treatment step as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Treatment_step + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Attack history as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         ACQ_baseline_score_mean + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```



```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Number of hospitalisation in the previous 12 months as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Number_hospitalisations_for_asthma_previous_12_months_con + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Smoking behaviour as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Smoking_0never_1ex_2current + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Pack years as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Pack_years + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])), 
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergic Rhinitis as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         AllergicRhinitis__0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Eczema as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Eczema_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Allergen sensitisation as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Chronic Rhinosinusitis as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Chronic_Rhinosinusitis_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Nasal polyposis as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Nasal_polyposis_0no_1yes_9999notknown + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Adherence in trial as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Adherence_InTrial_quantity + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% pre-bronchodilator as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FEV1_preBD_PCT_Baseline + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1% reversibility as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FEV1_PCT_reversibility_postBD + 
                         ACQ_baseline_score_mean +  
                         Any_severe_attack_previous_12m_0no_1yes + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FEV1/FVC ratio as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

# The command fit does not work here as FEV1/FVC ratio was coded after completing the imputed dataset

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                              FEV1_FVC_ratio + 
                              ACQ_baseline_score_mean + 
                              Any_severe_attack_previous_12m_0no_1yes + 
                              Treatment_step + 
                              FeNO_baseline_ppb + 
                              Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                              offset(Follow_up_duration_days) + 
                              as.factor(Enrolled_Trial_name), 
                            data = subset(imp_data_ORACLE_final_COMPLETE, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and ACQ-5 symptom score as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BEC per 10-fold as independent variable, adjusted for the core clinical set, biomarker FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step +
                         FeNO_baseline_ppb + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and BEC and FeNO per 2-fold as independent variable, adjusted for the core clinical set, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

# First, transform the original values for BEC and FeNO to log with base 2
## If not already done in negative binomial regression: univariable
imp_data_ORACLE_final_COMPLETE$BEC <- 
  10^(imp_data_ORACLE_final_COMPLETE$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced)

imp_data_ORACLE_final_COMPLETE$Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced_log2 <-
  log(imp_data_ORACLE_final_COMPLETE$BEC, base=2)

imp_data_ORACLE_final_COMPLETE$FeNO <- 
  10^(imp_data_ORACLE_final_COMPLETE$FeNO_baseline_ppb)

imp_data_ORACLE_final_COMPLETE$FeNO_baseline_ppb_log2 <- 
  log(imp_data_ORACLE_final_COMPLETE$FeNO, base=2)

# Then, fit the model
res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                              Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced_log2 + 
                              ACQ_baseline_score_mean + 
                              Any_severe_attack_previous_12m_0no_1yes + 
                              FEV1_preBD_PCT_Baseline + 
                              Treatment_step +
                              FeNO_baseline_ppb_log2 +
                              offset(Follow_up_duration_days) + 
                              as.factor(Enrolled_Trial_name), 
                            data = subset(imp_data_ORACLE_final_COMPLETE, .imp == i))
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE)
res_pool
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and FeNO per 10-fold as independent variable, adjusted for the core clinical set, biomarker BEC, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         FeNO_baseline_ppb + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```


```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and Total IgE as independent variable, adjusted for the core clinical set, biomarkers BEC and FeNO, offset follow-up duration and trial as factor variable. Rubin's rules were applied.

fit <- with(data=imp_data_ORACLE_final, 
            exp=glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                         Total_IgE + 
                         ACQ_baseline_score_mean + 
                         Any_severe_attack_previous_12m_0no_1yes + 
                         FEV1_preBD_PCT_Baseline + 
                         Treatment_step + 
                         FeNO_baseline_ppb + 
                         Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                         offset(Follow_up_duration_days) + 
                         as.factor(Enrolled_Trial_name)))

summary(pool(fit))
summary.fit <- summary(pool(fit))

pool.OR <- exp(cbind(summary.fit[,2], 
                     (summary.fit[,2]-1.96*(summary.fit[,3])),
                     (summary.fit[,2]+1.96*(summary.fit[,3]))))

colnames(pool.OR) <- (c("RR", "95% LO", "95% UP"))
pool.OR
```

# Negative binomial model: all covariates

```{r, eval = FALSE}
# A negative binomial model was fit for the number of severe asthma attacks during follow-up as a dependent variable and all covariates discussed as independent variables. Rubin's rules were applied.
## We excluded number of prev hospitalisations, smoking, FEV1/FVC ratio, FEV1% postBD and FEV1% Reversibility from the model, since these variables are (in part) captured by any attack in the past 12 months, pack years and FEV1% preBD

res_comb = NULL 

for(i in 1:10){
     res_comb[[i]] = glm.nb(Number_severe_asthma_attacks_during_followup ~ 
                              Age + # Add all covariates
                              Gender_0Female_1Male +
                              BMI +
                              ACQ_baseline_score_mean + 
                              Any_severe_attack_previous_12m_0no_1yes + 
                              FEV1_preBD_PCT_Baseline + 
                              Treatment_step + 
                              FeNO_baseline_ppb + 
                              Blood_Eos_baseline_x10_9_cells_per_L_zeroreplaced + 
                              Pack_years +
                              AllergicRhinitis__0no_1yes_9999notknown +
                              Airborne_allergen_sensitisation_on_testing_0no_1yes_9999notknown +
                              Eczema_0no_1yes_9999notknown +
                              CRSsNP +
                              CRSwNP +
                              Adherence_InTrial_quantity +
                              Total_IgE +
                              offset(Follow_up_duration_days) + 
                              as.factor(Enrolled_Trial_name), 
                            data = subset(imp_data_ORACLE_final_COMPLETE, .imp == i)) # fit a model per imputed dataset
}

res_pool <- summary(pool(res_comb), conf.int = TRUE, exp = TRUE) # pool the estimates of the results of 10 imputed data sets
res_pool
```


```{r, eval = FALSE}
# Calculate different units for Age, Adherence in trial, FEV1 and ACQ

# RR Age per 10 years
x = 1.01 # paste value of negative binomial model here (this is an example RR)
x^10

# RR FEV1 and Adherence in trial per 10%
x = 1.14 # paste value of negative binomial model here (this is an example RR)
log(x)
exp(-.Last.value)
.Last.value^10

# RR ACQ per 0.5 score
x = 1.15 # paste value of negative binomial model here (this is an example RR)
log(x)
exp(-.Last.value)
.Last.value^0.5

```